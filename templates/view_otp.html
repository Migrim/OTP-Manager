{% extends 'bootstrap/base.html' %}

{% block title %}View OTP Code{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/otp_view.css') }}">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
<link rel="icon" href=".{{ url_for('static', filename='favicon.ico') }}">
<link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
{% include 'navbar.html' %}
<div class="container">
    <div class="title">OTP Code for <span class="secret-name">{{ secret.name }}</span></div>
    <div class="secret-info">
        <p id="otp-code" class="clickable-otp">Current OTP Code: {{ otp_code }}</p>
    </div>
    <div class="progress">
        <div class="progress-bar bg-primary" id="progress-bar" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="30">
            <span class="progress-text" id="progress-text"></span>
        </div>
    </div>
    <div class="button-container">
        <a href="{{ url_for('home') }}" class="btn">Home</a>
        <a href="{{ url_for('add') }}" class="btn">Add Another Secret</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.getElementById('otp-code').addEventListener('click', async function() {
        const otpCodeText = document.getElementById('otp-code').innerText.split(': ')[1]; // This splits the text and takes the second part, which is the OTP code.
        if (navigator.clipboard) {
            try {
                await navigator.clipboard.writeText(otpCodeText);
                console.log('OTP Copied to clipboard');
            } catch (err) {
                console.error('Clipboard API failed, using fallback:', err);
                copyTextToClipboard(otpCodeText);  // Using fallback method
            }
        } else {
            console.error('Clipboard API not available, using fallback.');
            copyTextToClipboard(otpCodeText);  // Using fallback method
        }
    });

    function copyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;

        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        textArea.style.top = "-999999px";

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            const successful = document.execCommand('copy');
            const msg = successful ? 'successful' : 'unsuccessful';
            console.log('Fallback: Copying text command was ' + msg);
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
        }

        document.body.removeChild(textArea);
    }

    function refreshOTP() {
        fetch('/refresh_specific_code?name={{ secret.name }}')
            .then(response => response.json())
            .then(data => {
                const otpCodeElement = document.getElementById('otp-code');
                if (data.otp_code.current_otp !== otpCodeElement.innerText) {
                    otpCodeElement.innerText = 'Current OTP Code: ' + data.otp_code.current_otp;
                }
            })
            .catch(error => console.error('Error:', error));
    }

    setInterval(refreshOTP, 1000);

    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');

    function updateProgressBar() {
        const now = new Date();
        let seconds = now.getSeconds();
        let remainingSeconds = 30 - seconds % 30;
        const progressValue = (remainingSeconds / 30) * 100;
        progressBar.style.width = progressValue + '%';
        progressBar.setAttribute('aria-valuenow', remainingSeconds);
        progressText.innerText = remainingSeconds + 's';
    }

    updateProgressBar();
    setInterval(updateProgressBar, 1000);
</script>
{% endblock %}
