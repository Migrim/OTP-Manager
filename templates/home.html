<!DOCTYPE html>
<html>
<head>
    {% extends 'bootstrap/base.html' %}
    {% block title %} OTP List {% endblock %}
        {% block styles %}
        {{ super() }}
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
        <link rel="stylesheet" href="navbar.css">
        <link rel="stylesheet" href="{{ url_for('static', filename='styles/styles.css') }}">
    {% endblock %}

</head>
<body>
    {% block navbar %}
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="navbar-nav mr-auto">
            <a class="navbar-brand" href="{{ url_for('home') }}">Home</a> 
        </div>
        <div class="navbar-nav mr-auto">
            <a class="navbar-brand" href="{{ url_for('add') }}">Add</a>
        </div>
        <div class="navbar-nav mr-auto">
            <a class="navbar-brand" href="{{ url_for('view_logs') }}">Logs</a>
        </div>
        <div class="navbar-nav mr-auto">
            <a class="navbar-brand" href="{{ url_for('admin.admin_settings') }}">Settings</a>
        </div>
        <div class="navbar-nav mr-auto">
            <a class="navbar-brand" href="{{ url_for('about') }}">About</a>
        </div>        
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="navbar-nav ml-auto">
                    <div class="alert alert-warning alert-dismissible fade show mb-0" role="alert">
                        {{ messages[0] }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                </div>
            {% endif %}
        {% endwith %}
        
        <div id="logoutContainer">
            <div id="logoutBtn">
                <a class="navbar-brand" href="{{ url_for('logout') }}">
                    Logout
                    <i class="material-icons-outlined">logout</i>
                </a>
            </div>
            <div id="refreshBtn"> 
                <button onclick="manuallyRefreshOtps()" class="ref-btn">
                    Refresh
                    <i class="material-icons-outlined">refresh</i>
                </button>
            </div>                      
        </div>            
    </nav>
    {% endblock %}
        
    {% block content %}
    <div class="container">
        <h1 class="text-center text-white">One Time Passwords</h1>
    
        <form method="get" action="{{ url_for('search_blueprint.search_otp') }}" class="search-bar">
            <input type="text" id="searchInput" name="name" placeholder="Search for OTPs" />
            <select name="company" id="companyDropdown" class="form-select custom-dropdown" onchange="this.form.submit()">
                <option value="All Companies" {% if request.args.get('company') == "All Companies" %}selected{% endif %}>All Companies</option>
                {% for company in companies %}
                    <option value="{{ company.name }}" {% if request.args.get('company') == company.name %}selected{% endif %}>{{ company.name }}</option>
                {% endfor %}
            </select>
        </form>
        
        <div class="row">
            {% for otp in otp_codes %}
            <div class="col-md-4">
                <div class="alert alert-success mt-3">
                    Firma: {{ otp.company }} <br>
                    Name: {{ otp.name }} <br>
                    <p>Secret: <span class="spoiler">{{otp.secret}}</span></p>
                    OTP type: {{ otp.otp_type }} <br>
                    OTP code: <span class="otp-code" id="otp_code_{{ otp.name }}" onclick="copyToClipboard(this)">{{ otp.otp_code }}</span>
                    <div class="progress mt-2">
                        <div class="progress-bar" role="progressbar" style="width: 100%;" id="progressBar{{ otp.name }}" data-refresh-time="{{ otp.refresh_time }}">30s</div>
                    </div>
                    <div class="btn-group" role="group">
                        <form id="deleteForm_{{ otp.name }}" action="{{ url_for('delete_secret', name=otp.name) }}" method="post" style="display: inline-block;">
                            <button type="button" style="margin-right:5px" class="btn btn-danger delete-btn" data-toggle="modal" data-target="#deleteConfirmationModal" data-otp-name="{{ otp.name }}">
                                <i class="icon-center material-icons-outlined icon-small">delete</i>
                            </button>
                            <input type="hidden" name="otpName" value="{{ otp.name }}" />
                        </form>
                        <form action="{{ url_for('edit', name=otp.name) }}" method="get" style="display: inline-block;">
                            <button style="margin-right:5px" class="btn btn-primary">
                                <i class="icon-center material-icons-outlined icon-small">edit</i>
                            </button>
                            <button type="button" style="margin-right: 5px" class="btn btn-light" onclick="copyToClipboard(document.querySelector('#otp_code_{{ otp.name }}'))">
                                <i class="icon-center material-icons-outlined icon-small">content_copy</i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
                
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        <li class="page-item {% if page is not defined or page <= 1 %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('home', page=page-1) }}" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% for i in range(1, total_pages + 1) %}
                            <li class="page-item {% if i == page %}active custom-active{% endif %}">
                                <a class="page-link" href="{{ url_for('home', page=i) }}">{{ i }}</a>
                            </li>
                        {% endfor %}
                        <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('home', page=page+1) }}" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>

                <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <i class="material-icons-outlined">report</i>
                                <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
                            </div>
                            <div class="modal-body text-center">
                                <p class="my-4 text-danger">Are you sure you want to delete this item? This action cannot be undone.</p>
                            </div>
                            <div class="modal-footer justify-content-center">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                <button id="deleteConfirmationButton" type="button" class="btn btn-danger">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>                
                
                <div id="toast" class="toast">Copied to clipboard</div>
                <div class="copyright">© Sebastian Junginger 2023</div>

                <script>
                    const countdownIntervals = new Map();

                async function updateOtpCodes(otpCodes) {
                    otpCodes.forEach(otp => {
                        let otpCodeElement = document.getElementById(`otp_code_${otp.name}`);
                        let progressBar = document.getElementById(`progressBar${otp.name}`);

                        if (otpCodeElement) {
                            otpCodeElement.textContent = otp.otp_code;
                        }

                        if (progressBar) {
                            progressBar.style.width = '100%';
                            let duration = parseInt(progressBar.getAttribute('data-refresh-time'));
                            startCountdown(progressBar, duration);
                        }
                    });
                }

                async function manuallyRefreshOtps() {
                    try {
                        const response = await fetch('/refresh_codes_v2');
                        const data = await response.json();
                        updateOtpCodes(data.otp_codes);
                    } catch (error) {
                        console.error('Fetch error:', error);
                    }
                }

                function startAutoRefresh() {
                    manuallyRefreshOtps();

                    let currentTime = new Date();
                    let millisTillNextInterval = 30000 - (currentTime.getSeconds() * 1000 + currentTime.getMilliseconds()) % 30000;

                    setTimeout(() => {
                        manuallyRefreshOtps();
                        setInterval(manuallyRefreshOtps, 30000);
                    }, millisTillNextInterval);
                }

                function startCountdown(element, duration) {
                    if (countdownIntervals.has(element.id)) {
                        clearInterval(countdownIntervals.get(element.id));
                    }

                    const intervalId = setInterval(() => {
                        let current_time = new Date().getSeconds();
                        let remaining = duration - (current_time % duration);

                        if (remaining === 2) {
                            element.textContent = "fetching...";
                        } else if (remaining === 1) {
                            let otpName = element.id.replace('progressBar', '');
                            let otpCodeElement = document.getElementById(`otp_code_${otpName}`);
                            if (otpCodeElement) {
                                otpCodeElement.classList.add('flash');
                                setTimeout(() => otpCodeElement.classList.remove('flash'), 3000);
                            }
                        } else {
                            element.textContent = remaining + "s";
                        }

                        element.style.width = `${(remaining / duration * 100)}%`;

                        if (remaining <= 1) {
                            clearInterval(countdownIntervals.get(element.id));
                            manuallyRefreshOtps();
                        }
                    }, 1000);

                    countdownIntervals.set(element.id, intervalId);
                }

                // Debounce function
                function debounce(func, wait) {
                    let timeout;
                    return function() {
                        const context = this, args = arguments;
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(context, args), wait);
                    };
                }

                window.onload = function() {
                    let spoilerElements = document.getElementsByClassName('spoiler');
                    for (let i = 0; i < spoilerElements.length; i++) {
                        let originalText = spoilerElements[i].innerText;
                        spoilerElements[i].setAttribute('data-original', originalText);
                        spoilerElements[i].innerText = '●'.repeat(originalText.length);
                        spoilerElements[i].onmouseover = function() {
                            this.innerText = this.getAttribute('data-original');
                        }
                        spoilerElements[i].onmouseout = function() {
                            this.innerText = '●'.repeat(this.getAttribute('data-original').length);
                        }
                    }

                    let progressBars = document.getElementsByClassName('progress-bar');
                    for (let i = 0; i < progressBars.length; i++) {
                        let duration = parseInt(progressBars[i].getAttribute('data-refresh-time')); 
                        startCountdown(progressBars[i], duration);
                    }

                    let otpContainers = document.querySelectorAll('.alert.alert-success');
                    otpContainers.forEach(function(container) {
                        container.classList.add('fade-in');
                    });

                    startAutoRefresh();
                };

                document.getElementById('searchInput').addEventListener('input', function() {
                        var filter = this.value.toUpperCase();
                        var otpDivs = document.getElementsByClassName('col-md-4');
                        for (var i = 0; i < otpDivs.length; i++) {
                            var div = otpDivs[i];
                            var name = div.querySelector('.alert').textContent;
                            if (name.toUpperCase().indexOf(filter) > -1) {
                                div.style.display = '';
                            } else {
                                div.style.display = 'none';
                            }
                        }
                    });

                    function copyToClipboard(element) {
                        let text = element.textContent;
                        let input = document.createElement('input');
                        input.setAttribute('value', text);
                        document.body.appendChild(input);
                        input.select();
                        document.execCommand('copy');
                        document.body.removeChild(input);
                        
                        showToast();
                    }

                    function showToast() {
                        let toast = document.getElementById('toast');
                        toast.style.display = 'block';
                        setTimeout(() => {
                            toast.style.display = 'none';
                        }, 5000);
                    }

                    let formToSubmit;

                    document.addEventListener('DOMContentLoaded', (event) => {
                        document.querySelectorAll('.delete-btn').forEach((button) => {
                            button.addEventListener('click', function() {
                                let otpName = this.getAttribute('data-otp-name');
                                formToSubmit = document.getElementById(`deleteForm_${otpName}`);
                            });
                        });
                        
                        document.getElementById('deleteConfirmationButton').onclick = () => {
                            formToSubmit.submit();
                        };
                    });
                </script>
        {% endblock %}
    </body>
</html>