{% extends 'bootstrap/base.html' %}

{% block title %} Live Logs {% endblock %}

    {% block styles %}
    {{ super() }}
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/logs.css') }}">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css">
{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="navbar-nav mr-auto">
        <a class="navbar-brand" href="{{ url_for('home') }}">Home</a> 
    </div>
    <div class="navbar-nav mr-auto">
        <a class="navbar-brand" href="{{ url_for('add') }}">Add</a>
    </div>
    <div class="navbar-nav mr-auto">
        <a class="navbar-brand" href="{{ url_for('view_logs') }}">Logs</a>
    </div>
    <div class="navbar-nav mr-auto">
        <a class="navbar-brand" href="{{ url_for('admin.admin_settings') }}">Management</a>
    </div>    
    <div class="navbar-nav mr-auto">
        <a class="navbar-brand" href="{{ url_for('about') }}">About</a>
    </div>
    <div class="navbar-nav mr-auto">
        <a class="navbar-brand" href="{{ url_for('settings') }}">
            <i class="material-icons-outlined">settings</i> 
        </a>
    </div>   
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="navbar-nav ml-auto">
                <div class="alert alert-warning alert-dismissible fade show mb-0" role="alert">
                    {{ messages[0] }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            </div>
        {% endif %}
    {% endwith %}
    
    <div id="logoutContainer">
        <div id="logoutBtn">
            <a class="navbar-brand" href="{{ url_for('logout') }}">
                Logout
                <i class="material-icons-outlined">logout</i>
            </a>
        </div>                    
    </div>            
</nav>
{% endblock %}

{% block content %}
<style>

</style>

<div class="logs-section d-flex justify-content-between align-items-center">
    <div>
        {% if current_user.show_content_titles %}
            <h1 class="mb-0">Server Logs</h1>
        {% endif %}
    </div>
    <div class="toggle-switch">
        <input type="checkbox" id="filter-toggle" hidden>
        <button id="toggle-btn" aria-label="Toggle Filter">
            Show Start Messages
        </button>
    </div>
</div>

<div id="loading-placeholder" class="loading-animation">
    Fetching Logs from Server<span class="loading-dots">.</span>
</div>
<div class="logs-box" style="display: none;">
    <table id="logs-table" class="table table-dark table-striped">
        <thead>
            <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Type</th>
                <th>Message</th>
            </tr>
        </thead>
        <tbody id="logs">
        </tbody>
    </table>               
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    var previousLogs = ""; 

    function displayLogs() {
        var logsBox = $('.logs-box'); 
        var loadingPlaceholder = $('#loading-placeholder');
        $.getJSON('/get_logs', function(data) {
            var currentLogs = JSON.stringify(data.logs); 
            if (currentLogs !== previousLogs) {
                previousLogs = currentLogs;

                if (data.logs) {
                    loadingPlaceholder.hide();
                    logsBox.fadeIn('slow'); 
                } else {
                    loadingPlaceholder.show();
                    logsBox.hide();
                }
            }
        });
    }

    setInterval(displayLogs, 1000);

    function filterLogs(logLines) {
        return logLines.filter(function (logLine) {
            return filterToggle.is(':checked') || !logLine.includes('Server started');
        });
    }

    var filterToggle = $('#filter-toggle');

    function fetchAndUpdateLogs() {
        var filterStatus = filterToggle.is(':checked');
        $.getJSON('/get_logs', { filter_out: filterStatus }, function(data) {
            var logs = data.logs;
            var logLines = logs.split('\n');
            $('#logs').empty(); 
            logLines.forEach(function(logLine) {
                var logMatch = logLine.match(/(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}) \[(\w+)\] (.+)/);
                if (logMatch) {
                    var datetime = logMatch[1];
                    var type = logMatch[2];
                    var message = logMatch[3];
                    var datetimeParts = datetime.split(' ');
                    var date = datetimeParts[0];
                    var time = datetimeParts[1];
                    var typeClass = type.toLowerCase() === 'error' ? 'error-log' : type.toLowerCase() + '-log';
                    var logRow = '<tr>' +
                                    '<td>' + date + '</td>' +
                                    '<td>' + time + '</td>' +
                                    '<td class="' + typeClass + '">' + type + '</td>' +
                                    '<td>' + message + '</td>' +
                                '</tr>';
                    $('#logs').prepend(logRow); 
                }
            });
        });
    }

    setInterval(fetchAndUpdateLogs, 1000); 

    document.addEventListener('DOMContentLoaded', function() {
        var toggleButton = document.getElementById('toggle-btn');

        filterToggle.prop('checked', false);
        toggleButton.textContent = 'Hide Start Messages';

        toggleButton.addEventListener('click', function() {
            filterToggle.prop('checked', !filterToggle.prop('checked'));
            toggleButton.textContent = filterToggle.prop('checked') ? 'Show Start Messages' : 'Hide Start Messages';
            fetchAndUpdateLogs(); 
        });
    });
</script>

{% endblock %}